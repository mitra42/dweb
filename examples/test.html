<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Test page for Dweb</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script><!-- get JQUERY from google -->
    <!--<script src="http://localhost:4243/file/sb/SHA3256B64URL.BDCbn_l9rrlCdVkB9o6qozSP84HBCGors5dBLxdyro8="></script><!-- jquery-3.1.1.js-->
    <!--<script src="http://localhost:4243/file/mb/SHA3256B64URL.OylzjhbKQK5VOVMbvdK9Dkb4UDfOEHU8uCeSnzqiseE="></script>--><!-- dweb.js -->
    <script>
        // This is code intended to go in library when working
        // ====== IN PROGRESS BELOW HERE
        var dwebserver = '192.168.1.156'
        //var dwebserver = 'localhost'
        var dwebport = '4243'

        class TransportHttp {

            constructor(ipandport, options) {
                this.ipandport = ipandport;
                this.options = options; // Dictionary of options, currently unused
                this.baseurl = "http://" + ipandport[0] + ":" + ipandport[1] + "/";
            }

            static setup(ipandport, options) {
                return new TransportHttp(ipandport, options);
            }

            url(command, table, hash) {
                var url = this.baseurl + command + "/" + table + "/" + hash;
                return url;
            }
        }

        var transport = TransportHttp.setup([dwebserver, dwebport], {});

        class Block {
            constructor(hash, data) {
                this._hash = hash;  // Maybe null
                this._data = data;  // Maybe null
                this._table = 'b';
            }

            onloaded(verbose, options) {
                // Called after block succeeds, can pass options through
                if (verbose) { console.log("Block:onloaded:Storing _data to", options["dom_id"]); }
                if (options["dom_id"]) {
                            document.getElementById(options["dom_id"]).innerHTML = this._data;
                } // TODO make it handle img, or other non-HTML as reqd
            }

            block(table, verbose, options) {
                // table: overrides table of class
                // options: { dom_id:   id to put data retrieved.
                //TODO probably move this into transportHttp but leave success and failure out passing object to call as parameter
                // Based on python except table is reqd parameter (null not acceptable)
                // Locate and return a block, based on its multihash
                if (verbose) { console.log("Fetching block: table=", table || this._table, "hash=", this._hash); }
                let url = transport.url("block", table || this._table, this._hash);
                if (verbose) { console.log("Fetching block: url=",url); }
                let self = this;    // So can pass to success function
                $.ajax({
                    type: "GET",
                    url: url,
                    success: function(data) {
                        if (verbose) { console.log("Block returning data len=", data.length); }
                        self._data = data;
                        self.onloaded(verbose, options);
                    },
                    error: function(xhr, status, error) {
                        alert("TODO Block failure status="+status+" error="+error);
                    },
                });
            }
        }

        class StructuredBlock extends Block { //TODO can subclass SmartDict if used elsewhere
            constructor(hash) { //TODO support other things in construction
                super(hash, null); // _hash is _hash of SB, not of data
                this._table = "sb"; // Note this is cls.table on python but need to separate from dictionary
            }
            sblock(verbose, options) {
                // Locate and return a block, based on its multihash
                if (verbose) { console.log("Fetching StructuredBlock table=",this._table,"hash=",this._hash); }
                this.block(null, verbose, options);
                // Block fetched in the background - dont assume loaded here
            }
            onloaded(verbose, options) {
                this._dict = JSON.parse(this._data);
                if (options["dom_id"]) {
                    if (verbose) { console.log("StructuredBlock:onloaded:Storing data to", options["dom_id"]); }
                    document.getElementById(options["dom_id"]).innerHTML = this._dict["data"];
                } // TODO make it handle img, or other non-HTML as reqd based on this._dict["Content-type"]
            }
        }
        class SignedBlock {
            // TODO Build Signed Block - allow retrieval of SB from it
        }
        class SignedBlocks {
            // TODO Build SignedBlocks - allow to produce list of SigB and fetching them
        }
        class MutableBlock {
            // TODO Build MutableBlock - allow fetch of signatures, and fetching them
            // TODO allow fetching of most recent
        }
        class MutableBlockMaster {
            // TODO Build MutableBlockMaster - allow to drive editor (MCE)
        }

    </script>
    <script>
        // This is my current testing script first of block
        let b = new Block("SHA3256B64URL.50GNWgUQ9GgrVfMvpedEg77ByMRYkUgPRU9P1gWaNF8=", null); // Block with "clever dog..."
        b.block(null, true, {"dom_id": "myList.0"});      // Load block in background
        // Now of SB
        let sb = new StructuredBlock("SHA3256B64URL.aX4-6I6Ck0ZX9A2CgNpsBakD-GkRiCC8Aivm_ROegrM=");
        sb.sblock(true, {"dom_id": "myList.1"} ); // hash of SB containing data containing "I'm a paragraph" // Load SB in background
        //foo.load("myList.0");
    </script>


</head>
<body>
<H1>Test page for DWEB</H1>
<p>This page is a current test, will just be testing current (usually broken) stuff.</p>

<ul id="myList"><li id="myList.0">Initial unreplaced text</li><li id="myList.1">Dummy text of item1</li></ul>
</body>
</html>

